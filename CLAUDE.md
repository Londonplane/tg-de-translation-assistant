# CLAUDE.md

本文件为 Claude Code (claude.ai/code) 在处理此代码库时提供指导。

## 语言使用规范

**重要**: 所有与用户的对话和生成的文档必须使用中文。这是一个中文项目，用户期望得到中文回复。

## 开发命令

### 本地开发
```bash
# 启动本地开发服务器（选择其中一种）：
python -m http.server 8000
# 或者
npx serve .
# 或者使用 VS Code Live Server 扩展

# 访问应用程序
open http://localhost:8000
```

### 无构建系统
这是一个静态的 HTML/CSS/JavaScript 应用程序，无需构建过程、包管理器或安装依赖项。所有开发工作直接使用源文件进行。

## 应用架构

### 前端架构
- **纯静态单页应用**：使用原生 HTML5、CSS3 和 JavaScript 构建（无框架）
- **模块化设计**：6个独立的功能模块，可独立运行
- **多任务管理**：中德翻译模块支持最多3个并行任务，每个任务独立状态管理
- **基于类的状态管理**：`TranslationApp` 类管理应用状态和模块切换，`MultiTaskManager` 类管理多任务状态
- **响应式布局**：移动优先设计，支持桌面端和移动端，自适应1-3任务列布局

### 后端架构（无服务器）
- **Supabase Edge Functions**：使用 Deno 运行时的无服务器后端
- **API 代理服务**：位于 `supabase/functions/deepl-proxy/index.ts` 的 DeepL API 代理
- **双 API 集成**：
  - OpenRouter API 用于 AI 翻译（主要）
  - DeepL API 用于专业回译（可选）

### 数据存储
- **浏览器本地存储**：用户配置和词汇表存储在客户端
- **多用户支持**：每个浏览器支持多个 API 密钥配置
- **无数据库**：完全无状态的后端架构

## 项目文件结构

### 核心文件
- `index.html` - 主应用程序界面，包含所有模块定义
- `script.js` - 主应用程序逻辑、`TranslationApp` 类和模块处理器
- `api-integration.js` - API 集成层、用户管理、OpenRouter/DeepL 调用
- `styles.css` - 所有模块的完整响应式样式
- `prompts-config.js` - 基于角色的 AI 提示配置（包含中文字符）
- `config.js` - Supabase 配置和环境检测

### 后端服务
- `supabase/functions/deepl-proxy/index.ts` - 无服务器 DeepL API 代理，支持 CORS 处理
- `supabase/config.toml` - Supabase 本地配置

### 部署与CI/CD
- `.github/workflows/deploy.yml` - GitHub Pages 自动部署工作流

### 文档
- `README.md` - 中文完整功能文档
- `快速开始.md` - 中文快速入门指南
- `docs/github-pages-setup.md` - GitHub Pages 部署指南
- `docs/supabase-setup.md` - Supabase 配置指南

### 开发工具
- `.vscode/` - VS Code 编辑器配置
- `.gitignore` - Git 忽略文件配置

## 核心功能和模块

### 1. 中德翻译 (`cn-to-de`)
- **多任务并行处理**：支持同时进行1-3个独立翻译任务
- **可编辑任务标题**：任务标题可自定义编辑，支持本地存储，页面刷新后保持
- 6种基于角色的翻译风格（男/女教授、男/女助理、男/女水军）
- 智能 Sie/Du（正式/非正式）检测和转换
- 自动回译验证
- 词汇管理，支持自定义术语翻译
- 备注清洗功能
- 去除短横线和表情符号处理
- **任务级加载状态**：每个任务独立显示加载状态，不影响其他任务交互
- **新手教程功能**：内置使用教程模态框，详细介绍功能使用方法
- **翻译完成计时器**：翻译完成后自动开始计时，显示结果获得时间，最长计时20分钟

### 2. 德中翻译 (`de-to-cn`)
- 标准德语到中文翻译

### 3. OCR 图像识别 (`image-recognition`)
- 拖拽上传图片
- 剪贴板粘贴支持
- 从图片提取文本

### 4. Sie/Du 转换 (`du-sie-switch`)
- 德语正式/非正式代词转换

### 5. 德语语法检查 (`german-check`)
- AI 驱动的语法检查和优化

### 6. 德语助手 (`german-assistant`)
- 语法解释、词汇查询、文化背景

## AI 模型和配置

### 基于角色的模型
- **Claude 3.5 Sonnet**：用于所有翻译角色和功能模块（教授、助理、水军等）
- **GPT-4o Mini**：专门用于德语助手模块
- **模型选择**：在 `prompts-config.js` 中配置翻译角色，在 `script.js` 中配置德语助手

### API 集成
- **OpenRouter**：翻译和聊天的主要 AI 服务
- **DeepL**：可选的专业翻译服务，用于回译
- **单密钥队列机制**：多任务共享单个API密钥，避免并发冲突

## 配置管理

### 用户 API 密钥
- 支持多用户，每个用户独立管理 API 密钥
- 本地存储持久化
- 通过齿轮图标访问设置模态框
- API 连接测试功能

### 环境配置
- 开发环境与生产环境检测
- `config.js` 中的 Supabase URL 和密钥
- GitHub Pages 部署配置

## 部署

### GitHub Pages（生产环境）
- 通过 `.github/workflows/deploy.yml` 自动部署
- 静态文件复制到构建目录
- 无需构建过程
- 推送到主分支时自动部署

### 本地测试
- 任何 HTTP 服务器都可以提供静态文件服务
- 通过 Supabase Edge Functions 处理 CORS
- 无需本地后端

## 项目清理总结

### 已清理的内容
- **移除冗余代码**：删除了 `script.js` 中的模拟函数（`simulateTranslation`、`simulateConversion` 等），这些早期占位符已被真实API调用替代
- **清理注释代码**：移除了 `prompts-config.js` 中被注释的旧版翻译规则
- **更新文档**：修正了 README.md 中的过时信息，准确反映6种角色而非7种

### 项目现状
- **代码精简**：移除了约100行不必要的模拟代码
- **文档一致**：所有文档现在准确反映实际功能
- **功能完整**：6个核心模块全部基于真实API实现，无占位符代码

## 多任务功能实现

### 架构设计
- **多任务容器**：CSS Grid响应式布局，支持1-3个任务区域
- **状态隔离**：每个任务独立管理输入、输出、词汇表等状态
- **任务级加载**：按钮操作只影响对应任务区域，不阻塞其他任务
- **动态管理**：用户可动态添加/删除任务区域

### 技术实现
- **MultiTaskManager 类**：管理多任务状态和原文备份
- **ID 命名规范**：所有DOM元素使用 `${element}-${taskId}` 格式
- **showTaskLoading 方法**：支持不同按钮类型的任务级加载状态
- **事件处理**：所有事件处理器支持taskId参数传递

### 用户体验优化
- **视觉反馈**：加载中的任务区域显示蓝色边框和渐变背景
- **按钮状态**：不同操作显示对应的加载文本（翻译中、转换中、处理中等）
- **交互隔离**：一个任务的操作不影响其他任务的可用性

## 开发指南

### 项目特点
- **零依赖管理**：无需 npm install 或包管理
- **直接编辑**：修改源码即时生效
- **浏览器兼容**：支持现代浏览器的ES6+特性
- **UTF-8编码**：`prompts-config.js` 包含中文字符，确保编码正确

### 调试信息
- 项目中保留了错误处理的 console 输出用于调试
- 生产环境中这些日志有助于问题诊断和监控

## 最新功能更新

### 可编辑任务标题功能（2024年更新）
- **功能位置**：每个任务区域的标题部分
- **编辑方式**：
  - 直接点击任务标题进行编辑
  - 支持失去焦点时自动保存
  - 按Enter键保存并退出编辑
  - 实时保存（500ms防抖机制）
- **本地存储**：
  - 自动保存到localStorage
  - 页面刷新后自动恢复
  - 支持容错处理，失败时使用默认标题
- **用户体验**：
  - 平时看起来像普通标题
  - 悬停时显示可编辑提示
  - 编辑时显示聚焦状态
  - 响应式设计，适配各种屏幕尺寸
- **技术实现**：
  - HTML结构：input元素替代h3标题
  - JavaScript逻辑：基于MultiTaskManager类的标题管理
  - CSS样式：透明背景设计，交互时显示边框和阴影

### 翻译完成计时器功能（2024年更新）
- **功能位置**：中译德模块每个任务的"中文文本"标签右侧
- **计时逻辑**：
  - 翻译完成后自动开始计时
  - 实时显示结果获得时间（格式：MM:SS）
  - 最长计时20分钟，到达后显示"20:00+"
  - 重新翻译或清空时停止并重置计时器
  - 其他操作（编辑、转换等）不影响计时
- **技术实现**：
  - HTML结构：紧凑的标签行布局
  - JavaScript逻辑：基于MultiTaskManager类的计时器管理
  - CSS样式：与整体UI风格一致的设计

### 界面布局优化（2024年更新）
- **紧凑布局设计**：
  - 计时器与"中文文本"标签在同一行显示
  - 人称信息与"德语译文"标签在同一行显示
  - 删除冗余的"人称判断以左侧备注为准"提示
  - 人称显示文本简化为"人称：Du(你)形式"
- **响应式优化**：
  - 标签行使用flex布局，左右对齐
  - 计时器和人称信息尺寸紧凑，不占用过多空间
  - 保持移动端和桌面端的良好显示效果

### 新手教程系统
- **位置**：中译德模块头部左上角"📚 使用教程"按钮
- **内容**：完整的功能介绍和使用指南，包含角色选择、按钮功能、使用技巧等
- **交互**：支持多种关闭方式（X按钮、背景点击、ESC键、"开始使用"按钮）
- **响应式设计**：适配桌面和移动设备，确保内容完整显示
- **技术实现**：
  - HTML结构：教程模态框位于 `index.html:718-838`
  - CSS样式：完整的教程样式和响应式适配
  - JavaScript逻辑：事件监听和模态框控制方法